<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emlak AsistanÄ±</title>

<!-- FullCalendar CSS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
:root {
  --primary: #007bff;
  --primary-light: #4da3ff;
  --light-bg: #f4f7f9;
  --border: #e0e0e0;
  --radius: 12px;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --transition: 0.3s ease;
  --text-dark: #222;
  --text-muted: #666;
  --white: #fff;
}

/* === GENEL === */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background-color: var(--light-bg);
  color: var(--text-dark);
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* === KullanÄ±cÄ± Bilgisi === */
.user-info {
  position: absolute;
  top: 15px;
  right: 20px;
  background: var(--white);
  padding: 10px 18px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  font-size: 14px;
  text-align: right;
  color: var(--text-muted);
  transition: var(--transition);
}
.user-info a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 500;
}
.user-info a:hover {
  text-decoration: underline;
}

/* === KONTEYNER === */
.container {
  display: flex;
  flex-wrap: wrap;
  margin-top: 80px;
  gap: 20px;
  justify-content: center;
  padding: 0 20px 50px;
}

/* === SOL PANEL === */
.left-panel {
  flex: 1 1 320px;
  max-width: 380px;
  padding: 25px;
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  transition: var(--transition);
}
.left-panel h1 {
  margin: 0 0 10px 0;
  font-size: 22px;
  color: var(--text-dark);
}

#mic-button {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  background: linear-gradient(145deg, var(--primary), var(--primary-light));
  border: none;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  transition: 0.25s ease;
}
#mic-button:hover { transform: scale(1.06); }
#mic-button.recording { background: #dc3545; animation: pulse 1.5s infinite; }

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.5); }
  70% { box-shadow: 0 0 0 20px rgba(220,53,69,0); }
  100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); }
}

#transcript-output {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: var(--radius);
  padding: 15px;
  font-size: 15px;
  min-height: 130px;
  margin-top: 15px;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.08);
  background: #fafafa;
  transition: var(--transition);
}
#transcript-output:focus {
  outline: none;
  border-color: var(--primary);
  background: var(--white);
  box-shadow: 0 0 0 2px rgba(0,123,255,0.15);
}

.reminders {
  margin-top: 15px;
  text-align: center;
}
.badge {
  display: inline-block;
  background-color: #eef1f3;
  color: #333;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 12px;
  margin: 4px;
}

/* === SAÄž PANEL === */
.right-panel {
  flex: 3 1 650px;
  padding: 25px;
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  box-sizing: border-box;
  transition: var(--transition);
}

.section-title {
  border-left: 5px solid var(--primary);
  padding-left: 10px;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-dark);
  margin-top: 0;
  margin-bottom: 15px;
}

/* === TABLOLAR === */
.table-container {
  max-height: 35vh;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  background: var(--white);
  margin-bottom: 25px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  border-radius: var(--radius);
}
thead th {
  background: var(--primary);
  color: #fff;
  padding: 10px;
  position: sticky;
  top: 0;
  text-align: left;
  font-weight: 600;
}
td {
  padding: 8px 12px;
  border-bottom: 1px solid #f0f0f0;
}
tbody tr:hover {
  background-color: #f8f9ff;
  cursor: pointer;
}

/* === FÄ°LTRELER === */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}
.filters input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: var(--radius);
  font-size: 13px;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
  transition: var(--transition);
}
.filters input:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.15);
}

/* === TAKVÄ°M === */
#calendar {
  margin-top: 30px;
  border-radius: var(--radius);
  background: var(--white);
  box-shadow: var(--shadow);
  padding: 15px;
  width: 100%;
}

/* === MOBÄ°L === */
@media (max-width: 992px) {
  body { font-size: 15px; }
  .container { flex-direction: column; padding: 0 10px; }
  .left-panel, .right-panel { max-width: 100%; box-shadow: none; border-radius: 0; }
  #mic-button { width: 90px; height: 90px; }
  #transcript-output { font-size: 14px; }
  .filters { flex-direction: column; }
  .filters input { width: 100%; }
  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }
  thead { display: none; }
  tbody tr {
    margin-bottom: 15px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
  }
  td {
    border: none;
    padding: 5px 0;
    display: flex;
    justify-content: space-between;
    font-size: 14px;
  }
  td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--text-muted);
  }
}

</style>
</head>
<body>

<div class="user-info">
  {% if current_user.is_authenticated %}
    <p>HoÅŸgeldin, <strong>{{ current_user.name }}</strong></p>
    <a href="/logout">Ã‡Ä±kÄ±ÅŸ Yap</a>
  {% endif %}
</div>

<div class="container">
  <!-- Sol Panel -->
  <div class="left-panel">
    <h1 style="margin-top:0;">Sesli Not Al</h1>
    <button id="mic-button"><div id="mic-icon"></div></button>
    <textarea id="transcript-output" placeholder="Mikrofon butonuna basÄ±p konuÅŸmaya baÅŸlayÄ±n..."></textarea>

    <div class="reminders">
      <span class="badge">Kaynak</span> <span class="badge">MÃ¼ÅŸteri AdÄ±</span> <span class="badge">Telefon</span>
      <span class="badge">Taraf</span> <span class="badge">BÃ¼tÃ§e</span> <span class="badge">Oda SayÄ±sÄ±</span>
      <span class="badge">Ä°lÃ§e</span> <span class="badge">Mahalle</span> <span class="badge">Aksiyon</span> <span class="badge">HatÄ±rlatma</span>
    </div>
    <div id="confirmation-buttons">
      <p>Metni dÃ¼zenleyip onaylayabilirsiniz.</p>
      <button id="btn-yes" class="btn" style="background:#28a745;color:#fff;">Onayla</button>
      <button id="btn-no" class="btn" style="background:#6c757d;color:#fff;">Ä°ptal</button>
    </div>
    <div id="status-message"></div>
  </div>

  <!-- SaÄŸ Panel -->
  <div class="right-panel">
    <h2 class="section-title">YaklaÅŸan GÃ¶revlerim</h2>
    <div class="filters">
      <input type="text" onkeyup="filterTable('tasks-table', 0, this)" placeholder="Tarihe gÃ¶re...">
      <input type="text" onkeyup="filterTable('tasks-table', 1, this)" placeholder="Aksiyona gÃ¶re...">
      <input type="text" onkeyup="filterTable('tasks-table', 2, this)" placeholder="MÃ¼ÅŸteriye gÃ¶re...">
    </div>
    <div class="table-container">
      <table id="tasks-table">
        <thead><tr><th>Tarih</th><th>Aksiyon</th><th>MÃ¼ÅŸteri</th></tr></thead>
        <tbody>
          {% for record in records %}
          {% if record.Aksiyonlar and record.Aksiyonlar != 'Belirtilmedi' %}
          <tr>
            <td>{{ record.HatÄ±rlatma_Tarihi.split(' ')[0] if record.HatÄ±rlatma_Tarihi and ' ' in record.HatÄ±rlatma_Tarihi else record.HatÄ±rlatma_Tarihi }}</td>
            <td>{{ record.Aksiyonlar }}</td>
            <td>{{ record.MÃ¼ÅŸteri_AdÄ± or 'N/A' }}</td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h2 class="section-title" style="margin-top:30px;">TÃ¼m KayÄ±tlarÄ±m</h2>
    <div class="filters">
      <input type="text" onkeyup="filterTable('results-table', 0, this)" placeholder="KaynaÄŸa gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 1, this)" placeholder="MÃ¼ÅŸteriye gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 2, this)" placeholder="Ä°lÃ§eye gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 3, this)" placeholder="Mahalleye gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 4, this)" placeholder="BÃ¼tÃ§eye gÃ¶re...">
    </div>
    <div class="table-container">
      <table id="results-table">
        <thead><tr><th>Kaynak</th><th>MÃ¼ÅŸteri</th><th>Ä°lÃ§e</th><th>Mahalle</th><th>BÃ¼tÃ§e</th></tr></thead>
        <tbody>
          {% for record in records %}
          <tr>
            <td>{{ record.Kaynak or 'N/A' }}</td>
            <td>{{ record.MÃ¼ÅŸteri_AdÄ± or 'N/A' }}</td>
            <td>{{ record.Konum or 'N/A' }}</td>
            <td>{{ record.Mahalle or 'N/A' }}</td>
            <td>{{ record.Butce or 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Takvim GÃ¶rÃ¼nÃ¼mÃ¼ -->
    <h2 class="section-title" style="margin-top:40px;">ðŸ“… Takvim GÃ¶rÃ¼nÃ¼mÃ¼</h2>
    <div id="calendar"></div>
  </div>
</div>

<!-- ==================== SCRIPTLER ==================== -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

<script>


        function filterTable(tableId, columnIndex, inputElement) {
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
            const filter = inputElement.value.toUpperCase();

            for (let i = 0; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName("td")[columnIndex];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        const micButton = document.getElementById('mic-button');
        const transcriptTextarea = document.getElementById('transcript-output');
        const confirmationButtons = document.getElementById('confirmation-buttons');
        const btnYes = document.getElementById('btn-yes');
        const btnNo = document.getElementById('btn-no');
        const statusMessage = document.getElementById('status-message');
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'tr-TR';
            recognition.interimResults = true;
            let isRecording = false;

            micButton.addEventListener('click', () => {
                isRecording = !isRecording;
                if (isRecording) {
                    transcriptTextarea.value = '';
                    recognition.start();
                    micButton.classList.add('recording');
                    transcriptTextarea.placeholder = 'Dinliyorum...';
                    statusMessage.textContent = '';
                    confirmationButtons.style.display = 'none';
                } else {
                    recognition.stop();
                    micButton.classList.remove('recording');
                }
            });

            recognition.onresult = (event) => {
                let finalTranscriptPart = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscriptPart = transcript + ' ';
                    }
                }
                transcriptTextarea.value += finalTranscriptPart;
                transcriptTextarea.scrollTop = transcriptTextarea.scrollHeight;
            };

            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                } else {
                    micButton.classList.remove('recording');
                    transcriptTextarea.placeholder = 'Mikrofon butonuna basÄ±p konuÅŸmaya baÅŸlayÄ±n...';
                    if (transcriptTextarea.value.trim().length > 0) {
                        confirmationButtons.style.display = 'block';
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech Recognition Error", event.error);
                isRecording = false;
                micButton.classList.remove('recording');
            }

        } else {
            micButton.disabled = true;
            transcriptTextarea.placeholder = "TarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor."
        }

        btnNo.addEventListener('click', () => {
            transcriptTextarea.value = '';
            transcriptTextarea.placeholder = 'Ä°ptal edildi. Tekrar denemek iÃ§in mikrofona basÄ±n.';
            confirmationButtons.style.display = 'none';
        });

        btnYes.addEventListener('click', async () => {
            statusMessage.textContent = 'Ä°ÅŸleniyor, lÃ¼tfen bekleyin...';
            confirmationButtons.style.display = 'none';
            const editedTranscript = transcriptTextarea.value;
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript: editedTranscript })
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    statusMessage.textContent = 'BaÅŸarÄ±yla kaydedildi! Sayfa yenileniyor...';
                    setTimeout(() => { window.location.reload(); }, 1500);
                } else {
                    statusMessage.textContent = `Hata: ${result.message}`;
                }
            } catch (error) {
                console.error('Fetch hatasÄ±:', error);
                statusMessage.textContent = 'Sunucuya baÄŸlanÄ±rken bir hata oluÅŸtu.';
            }
        });
    
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) return;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'tr',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events: [
      {% for record in records %}
        {% if record.HatÄ±rlatma_Tarihi and record.HatÄ±rlatma_Tarihi != 'Belirtilmedi' %}
        {
          title: '{{ record.Aksiyonlar|default("GÃ¶rev")|escape }} - {{ record.MÃ¼ÅŸteri_AdÄ±|default("MÃ¼ÅŸteri")|escape }}',
          start: '{{ record.HatÄ±rlatma_Tarihi.split(" ")[0] }}',
          allDay: true,
          extendedProps: {
            musteri: '{{ record.MÃ¼ÅŸteri_AdÄ±|default("Belirtilmedi")|escape }}',
            telefon: '{{ record.Telefon|default("Belirtilmedi")|escape }}',
            notlar: '{{ record.Notlar|default("Belirtilmedi")|escape }}',
            konum: '{{ record.Konum|default("Belirtilmedi")|escape }}',
            mahalle: '{{ record.Mahalle|default("Belirtilmedi")|escape }}'
          }
        },
        {% endif %}
      {% endfor %}
    ],
    eventColor: '#007bff',
    eventTextColor: 'white',

    eventMouseEnter: function(info) {
      const event = info.event;
      const tooltip = document.createElement('div');
      tooltip.classList.add('fc-tooltip');
      tooltip.innerHTML = `
        <strong>${event.title}</strong><br>
        <b>MÃ¼ÅŸteri:</b> ${event.extendedProps.musteri}<br>
        <b>Telefon:</b> ${event.extendedProps.telefon}<br>
        <b>Konum:</b> ${event.extendedProps.konum} / ${event.extendedProps.mahalle}<br>
        <b>Not:</b> ${event.extendedProps.notlar}
      `;
      document.body.appendChild(tooltip);
      tooltip.style.position = 'absolute';
      tooltip.style.background = 'rgba(0,0,0,0.8)';
      tooltip.style.color = 'white';
      tooltip.style.padding = '8px 12px';
      tooltip.style.borderRadius = '6px';
      tooltip.style.fontSize = '13px';
      tooltip.style.pointerEvents = 'none';
      tooltip.style.transition = '0.1s';
      tooltip.style.zIndex = 9999;

      const moveTooltip = (e) => {
        tooltip.style.left = e.pageX + 10 + 'px';
        tooltip.style.top = e.pageY + 10 + 'px';
      };
      moveTooltip(info.jsEvent);
      document.addEventListener('mousemove', moveTooltip);

      info.el.addEventListener('mouseleave', () => {
        tooltip.remove();
        document.removeEventListener('mousemove', moveTooltip);
      });
    }
  });

  calendar.render();
});
</script>

</body>
</html>



