<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emlak AsistanÄ±</title>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">

<style>
:root {
  --primary: #007bff;
  --light-bg: #f4f7f9;
  --border: #e0e0e0;
  --radius: 10px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background-color: var(--light-bg);
  color: #333;
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.user-info {
  position: absolute;
  top: 10px;
  right: 20px;
  text-align: right;
  z-index: 10;
  font-size: 14px;
}

/* === ANA KAPSAYICI === */
.container {
  display: flex;
  flex-wrap: wrap;
  margin-top: 60px;
}

/* === SOL PANEL === */
.left-panel {
  flex: 1 1 300px;
  max-width: 360px;
  padding: 25px;
  border-right: 1px solid var(--border);
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

#mic-button {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background-color: var(--primary);
  border: none;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  transition: 0.3s;
}
#mic-button:hover { background-color: #0056b3; }
#mic-button.recording { background-color: #dc3545; animation: pulse 1.5s infinite; }

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.5); }
  70% { box-shadow: 0 0 0 20px rgba(220,53,69,0); }
  100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); }
}

#mic-icon {
  width: 50px;
  height: 50px;
  background-color: white;
  -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/></svg>') center / contain no-repeat;
}

#transcript-output {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: var(--radius);
  padding: 15px;
  font-size: 15px;
  min-height: 130px;
  box-sizing: border-box;
  resize: vertical;
}

.reminders { margin-top: 10px; text-align: center; }
.badge {
  display: inline-block;
  background-color: #eef1f3;
  color: #333;
  padding: 5px 10px;
  border-radius: 12px;
  font-size: 12px;
  margin: 3px;
}

/* === SAÄž PANEL === */
.right-panel {
  flex: 3 1 600px;
  padding: 25px;
  background: #fff;
  border-left: 1px solid var(--border);
  box-sizing: border-box;
}

.section-title {
  border-bottom: 2px solid var(--primary);
  padding-bottom: 5px;
  font-size: 18px;
  font-weight: 600;
  margin-top: 0;
  margin-bottom: 15px;
}

.table-container {
  max-height: 35vh;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: var(--radius);
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 8px 10px;
  border-bottom: 1px solid #eee;
}
thead th {
  background: #f8f9fa;
  position: sticky;
  top: 0;
}

.filters {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}
.filters input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: var(--radius);
  font-size: 13px;
}

/* === TAKVÄ°M === */
#calendar {
  margin-top: 30px;
  border: 1px solid #ddd;
  border-radius: var(--radius);
  padding: 10px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* === MOBÄ°L === */
@media (max-width: 992px) {
  .container { flex-direction: column; }
  .left-panel, .right-panel {
    max-width: 100%;
    border: none;
    border-bottom: 1px solid var(--border);
  }
  #calendar { margin-bottom: 30px; }
  .section-title { text-align: center; }
}

#confirmation-buttons {
  display: none;
}

.fc-tooltip {
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Flex Ã§ocuklarÄ±nÄ±n dar ekranda 0px'e sÄ±kÄ±ÅŸmasÄ±nÄ± engelle */
.right-panel { min-width: 0; }

/* Tablo: mobilde kart gibi dikey dizilsin (baÅŸlÄ±klar sol etikete dÃ¶nÃ¼ÅŸÃ¼r) */
@media (max-width: 768px) {
  .table-container { max-height: unset; } /* mobilde sabit yÃ¼kseklik kÄ±sÄ±tÄ±nÄ± kaldÄ±r */
  table.responsive { 
    border: 0; 
  }
  table.responsive thead {
    display: none; /* baÅŸlÄ±k gizlenir, td:before ile gÃ¶sterilecek */
  }
  table.responsive, 
  table.responsive tbody, 
  table.responsive tr, 
  table.responsive td {
    display: block;
    width: 100%;
  }
  table.responsive tr {
    background: #fff;
    margin: 0 0 12px 0;
    border: 1px solid #eee;
    border-radius: var(--radius);
    padding: 8px 10px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
  table.responsive td {
    border: 0;
    border-bottom: 1px dashed #eee;
    padding: 8px 6px;
  }
  table.responsive td:last-child {
    border-bottom: 0;
  }
  table.responsive td::before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
    color: #555;
  }

  /* FullCalendar mobil ayarlarÄ± */
  .fc .fc-toolbar-title { font-size: 1.1rem; }
  .fc .fc-toolbar-chunk { flex-wrap: wrap; gap: 6px; }
  #calendar { padding: 6px; }
}

/* Yatay kaydÄ±rma alternatifi (kart dÃ¼zenini istemezsen, tabloya .scrollable ekleyebilirsin) */
.table-container.scrollable { overflow-x: auto; }
table.scrollable { min-width: 640px; }

</style>
</head>
<body>

<div class="user-info">
  {% if current_user.is_authenticated %}
    <p>HoÅŸgeldin, <strong>{{ current_user.name }}</strong></p>
    <a href="/logout">Ã‡Ä±kÄ±ÅŸ Yap</a>
  {% endif %}
</div>

<div class="container">
  <!-- Sol Panel -->
  <div class="left-panel">
    <h1 style="margin-top:0;">Sesli Not Al</h1>
    <button id="mic-button"><div id="mic-icon"></div></button>
    <textarea id="transcript-output" placeholder="Mikrofon butonuna basÄ±p konuÅŸmaya baÅŸlayÄ±n..."></textarea>

    <div class="reminders">
      <span class="badge">Kaynak</span> <span class="badge">MÃ¼ÅŸteri AdÄ±</span> <span class="badge">Telefon</span>
      <span class="badge">Taraf</span> <span class="badge">BÃ¼tÃ§e</span> <span class="badge">Oda SayÄ±sÄ±</span>
      <span class="badge">Ä°lÃ§e</span> <span class="badge">Mahalle</span> <span class="badge">Aksiyon</span> <span class="badge">HatÄ±rlatma</span>
    </div>
    <div id="confirmation-buttons">
      <p>Metni dÃ¼zenleyip onaylayabilirsiniz.</p>
      <button id="btn-yes" class="btn" style="background:#28a745;color:#fff;">Onayla</button>
      <button id="btn-no" class="btn" style="background:#6c757d;color:#fff;">Ä°ptal</button>
    </div>
    <div id="status-message"></div>
  </div>

  <!-- SaÄŸ Panel -->
  <div class="right-panel">
    <h2 class="section-title">YaklaÅŸan GÃ¶revlerim</h2>
    <div class="filters">
      <input type="text" onkeyup="filterTable('tasks-table', 0, this)" placeholder="Tarihe gÃ¶re...">
      <input type="text" onkeyup="filterTable('tasks-table', 1, this)" placeholder="Aksiyona gÃ¶re...">
      <input type="text" onkeyup="filterTable('tasks-table', 2, this)" placeholder="MÃ¼ÅŸteriye gÃ¶re...">
    </div>
    <div class="table-container">
      <table id="tasks-table" class="responsive">
        <thead><tr><th>Tarih</th><th>Aksiyon</th><th>MÃ¼ÅŸteri</th></tr></thead>
        <tbody>
          {% for record in records %}
          {% if record.Aksiyonlar and record.Aksiyonlar != 'Belirtilmedi' %}
          <tr>
            <td>{{ record.HatÄ±rlatma_Tarihi.split(' ')[0] if record.HatÄ±rlatma_Tarihi and ' ' in record.HatÄ±rlatma_Tarihi else record.HatÄ±rlatma_Tarihi }}</td>
            <td>{{ record.Aksiyonlar }}</td>
            <td>{{ record.MÃ¼ÅŸteri_AdÄ± or 'N/A' }}</td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h2 class="section-title" style="margin-top:30px;">TÃ¼m KayÄ±tlarÄ±m</h2>
    <div class="filters">
      <input type="text" onkeyup="filterTable('results-table', 0, this)" placeholder="KaynaÄŸa gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 1, this)" placeholder="MÃ¼ÅŸteriye gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 2, this)" placeholder="Ä°lÃ§eye gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 3, this)" placeholder="Mahalleye gÃ¶re...">
      <input type="text" onkeyup="filterTable('results-table', 4, this)" placeholder="BÃ¼tÃ§eye gÃ¶re...">
    </div>
    <div class="table-container">
      <table id="results-table" class="responsive">
        <thead><tr><th>Kaynak</th><th>MÃ¼ÅŸteri</th><th>Ä°lÃ§e</th><th>Mahalle</th><th>BÃ¼tÃ§e</th></tr></thead>
        <tbody>
          {% for record in records %}
          <tr>
            <td>{{ record.Kaynak or 'N/A' }}</td>
            <td>{{ record.MÃ¼ÅŸteri_AdÄ± or 'N/A' }}</td>
            <td>{{ record.Konum or 'N/A' }}</td>
            <td>{{ record.Mahalle or 'N/A' }}</td>
            <td>{{ record.Butce or 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Takvim GÃ¶rÃ¼nÃ¼mÃ¼ -->
    <h2 class="section-title" style="margin-top:40px;">ðŸ“… Takvim GÃ¶rÃ¼nÃ¼mÃ¼</h2>
    <div id="calendar"></div>
  </div>
</div>


    <script>
        function filterTable(tableId, columnIndex, inputElement) {
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
            const filter = inputElement.value.toUpperCase();

            for (let i = 0; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName("td")[columnIndex];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        const micButton = document.getElementById('mic-button');
        const transcriptTextarea = document.getElementById('transcript-output');
        const confirmationButtons = document.getElementById('confirmation-buttons');
        const btnYes = document.getElementById('btn-yes');
        const btnNo = document.getElementById('btn-no');
        const statusMessage = document.getElementById('status-message');
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'tr-TR';
            recognition.interimResults = true;
            let isRecording = false;

            micButton.addEventListener('click', () => {
                isRecording = !isRecording;
                if (isRecording) {
                    transcriptTextarea.value = '';
                    recognition.start();
                    micButton.classList.add('recording');
                    transcriptTextarea.placeholder = 'Dinliyorum...';
                    statusMessage.textContent = '';
                    confirmationButtons.style.display = 'none';
                } else {
                    recognition.stop();
                    micButton.classList.remove('recording');
                }
            });

            recognition.onresult = (event) => {
                let finalTranscriptPart = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscriptPart = transcript + ' ';
                    }
                }
                transcriptTextarea.value += finalTranscriptPart;
                transcriptTextarea.scrollTop = transcriptTextarea.scrollHeight;
            };

            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                } else {
                    micButton.classList.remove('recording');
                    transcriptTextarea.placeholder = 'Mikrofon butonuna basÄ±p konuÅŸmaya baÅŸlayÄ±n...';
                    if (transcriptTextarea.value.trim().length > 0) {
                        confirmationButtons.style.display = 'block';
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech Recognition Error", event.error);
                isRecording = false;
                micButton.classList.remove('recording');
            }

        } else {
            micButton.disabled = true;
            transcriptTextarea.placeholder = "TarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor."
        }

        btnNo.addEventListener('click', () => {
            transcriptTextarea.value = '';
            transcriptTextarea.placeholder = 'Ä°ptal edildi. Tekrar denemek iÃ§in mikrofona basÄ±n.';
            confirmationButtons.style.display = 'none';
        });

        btnYes.addEventListener('click', async () => {
            statusMessage.textContent = 'Ä°ÅŸleniyor, lÃ¼tfen bekleyin...';
            confirmationButtons.style.display = 'none';
            const editedTranscript = transcriptTextarea.value;
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript: editedTranscript })
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    statusMessage.textContent = 'BaÅŸarÄ±yla kaydedildi! Sayfa yenileniyor...';
                    setTimeout(() => { window.location.reload(); }, 1500);
                } else {
                    statusMessage.textContent = `Hata: ${result.message}`;
                }
            } catch (error) {
                console.error('Fetch hatasÄ±:', error);
                statusMessage.textContent = 'Sunucuya baÄŸlanÄ±rken bir hata oluÅŸtu.';
            }
        });
    </script>


    <script>
/* Tablo baÅŸlÄ±klarÄ±nÄ± alÄ±p her tdâ€™ye data-label olarak yaz */
function makeTablesResponsive() {
  const tables = document.querySelectorAll('table.responsive');
  tables.forEach(table => {
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      Array.from(tr.children).forEach((td, i) => {
        td.setAttribute('data-label', headers[i] || '');
      });
    });
  });
}
document.addEventListener('DOMContentLoaded', makeTablesResponsive);
</script>

    <!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const isSmall = window.matchMedia('(max-width: 768px)').matches;
  const calendarEl = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: isSmall ? 'listWeek' : 'dayGridMonth',
    locale: 'tr',
    height: 'auto',
    contentHeight: 'auto',
    expandRows: true,
    dayMaxEvents: true,
    aspectRatio: isSmall ? 1 : 1.35,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: isSmall ? 'listWeek,dayGridMonth' : 'dayGridMonth,timeGridWeek,listWeek'
    },
    events: [
      {% for record in records %}
        {% if record.HatÄ±rlatma_Tarihi and record.HatÄ±rlatma_Tarihi != 'Belirtilmedi' %}
        {
          title: '{{ record.Aksiyonlar|default("GÃ¶rev")|escape }} - {{ record.MÃ¼ÅŸteri_AdÄ±|default("MÃ¼ÅŸteri")|escape }}',
          start: '{{ record.HatÄ±rlatma_Tarihi.split(" ")[0] }}',
          allDay: true,
          extendedProps: {
            musteri: '{{ record.MÃ¼ÅŸteri_AdÄ±|default("Belirtilmedi")|escape }}',
            telefon: '{{ record.Telefon|default("Belirtilmedi")|escape }}',
            notlar: '{{ record.Notlar|default("Belirtilmedi")|escape }}',
            konum: '{{ record.Konum|default("Belirtilmedi")|escape }}',
            mahalle: '{{ record.Mahalle|default("Belirtilmedi")|escape }}'
          }
        },
        {% endif %}
      {% endfor %}
    ],
    eventColor: '#007bff',
    eventTextColor: 'white',

    /* Dokunmatik cihazlarda hover yerine tÄ±kla â†’ bilgi gÃ¶ster */
    eventClick: function(info) {
      const e = info.event;
      const lines = [
        e.title,
        'MÃ¼ÅŸteri: ' + (e.extendedProps.musteri || '-'),
        'Telefon: ' + (e.extendedProps.telefon || '-'),
        'Konum: ' + (e.extendedProps.konum || '-') + ' / ' + (e.extendedProps.mahalle || '-'),
        'Not: ' + (e.extendedProps.notlar || '-')
      ];
      alert(lines.join('\n'));
    },

    /* MasaÃ¼stÃ¼ iÃ§in hover tooltip (mevcut kodun daha gÃ¼venli versiyonu) */
    eventMouseEnter: function(info) {
      if (matchMedia('(hover: hover)').matches === false) return; // dokunmatiklerde aÃ§ma
      const event = info.event;
      const tooltip = document.createElement('div');
      tooltip.classList.add('fc-tooltip');
      tooltip.innerHTML = `
        <strong>${event.title}</strong><br>
        <b>MÃ¼ÅŸteri:</b> ${event.extendedProps.musteri}<br>
        <b>Telefon:</b> ${event.extendedProps.telefon}<br>
        <b>Konum:</b> ${event.extendedProps.konum} / ${event.extendedProps.mahalle}<br>
        <b>Not:</b> ${event.extendedProps.notlar}
      `;
      document.body.appendChild(tooltip);
      Object.assign(tooltip.style, {
        position: 'absolute',
        background: 'rgba(0,0,0,0.85)',
        color: '#fff',
        padding: '8px 12px',
        borderRadius: '6px',
        fontSize: '13px',
        pointerEvents: 'none',
        transition: '0.1s',
        zIndex: 9999
      });

      const moveTooltip = (e) => {
        tooltip.style.left = e.pageX + 10 + 'px';
        tooltip.style.top = e.pageY + 10 + 'px';
      };
      moveTooltip(info.jsEvent);
      document.addEventListener('mousemove', moveTooltip);

      info.el.addEventListener('mouseleave', () => {
        tooltip.remove();
        document.removeEventListener('mousemove', moveTooltip);
      }, { once: true });
    }
  });

  /* Ã–NEMLÄ°: render() Ã§aÄŸrÄ±sÄ± olmazsa bazÄ± cihazlarda hiÃ§ gÃ¶rÃ¼nmeyebilir */
  calendar.render();

  /* Ekran dÃ¶ndÃ¼rmede / boyut deÄŸiÅŸince gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle */
  window.addEventListener('resize', () => {
    const smallNow = window.matchMedia('(max-width: 768px)').matches;
    const desired = smallNow ? 'listWeek' : 'dayGridMonth';
    if (calendar.view.type !== desired) calendar.changeView(desired);
  });
});
</script>


</body>
</html>
